<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image â†” Code Converter (22Ã—33 grid)</title>
<style>
  body { font-family: system-ui, sans-serif; background: #f9f9f9; color: #222; text-align: center; padding: 2rem; }
  h1 { margin-bottom: 1rem; }
  input, textarea, button { margin: 0.5rem; padding: 0.5rem; font-size: 1rem; }
  canvas { margin-top: 1rem; background: #eee; image-rendering: pixelated; }
  textarea { width: 90%; height: 5rem; font-family: monospace; }
</style>
</head>
<body>

<h1>ðŸ§© Image â†” Code Converter</h1>
<p>Upload a 22Ã—33 (or any) image to encode, or paste a 121-character string to decode.</p>

<!-- Encode section -->
<h2>Encode Image â†’ String</h2>
<input type="file" id="upload" accept="image/*"><br>
<textarea id="output" readonly placeholder="Encoded string will appear here..."></textarea>

<!-- Decode section -->
<h2>Decode String â†’ Image</h2>
<textarea id="inputString" placeholder="Paste 121-character string here..."></textarea><br>
<button id="decodeBtn">Decode</button><br>
<canvas id="canvas" width="220" height="330"></canvas>

<script>
<script>
const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

function encodeImage(img) {
  const w = 22, h = 33;
  const off = document.createElement('canvas');
  off.width = w; off.height = h;
  const ctx = off.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);

  const data = ctx.getImageData(0, 0, w, h).data;
  let result = "";

  for (let by = 0; by < h; by += 3) {
    for (let bx = 0; bx < w; bx += 2) {
      let blockValue = 0, bit = 0;
      for (let y = 0; y < 3; y++) {
        for (let x = 0; x < 2; x++) {
          const idx = ((by + y) * w + (bx + x)) * 4;
          const r = data[idx], g = data[idx + 1], b = data[idx + 2];
          const brightness = (r + g + b) / 3;
          if (brightness < 128) blockValue |= (1 << bit);
          bit++;
        }
      }
      blockValue = 63 - blockValue;
      result += alphabet[blockValue];
    }
  }
  return result;
}

function decodeStringToCanvas(code, canvas, scale = 10) {
  const w = 22, h = 33;
  if (code.length !== 121) {
    alert("Invalid string length â€” must be 121 characters.");
    return;
  }

  // Create an offscreen 22Ã—33 image first
  const off = document.createElement('canvas');
  off.width = w;
  off.height = h;
  const ctx = off.getContext('2d');
  const imageData = ctx.createImageData(w, h);
  const data = imageData.data;

  let index = 0;
  for (let by = 0; by < h; by += 3) {
    for (let bx = 0; bx < w; bx += 2) {
      let val = alphabet.indexOf(code[index++]);
      val = 63 - val;
      let bit = 0;
      for (let y = 0; y < 3; y++) {
        for (let x = 0; x < 2; x++) {
          const on = (val >> bit) & 1;
          const idx = ((by + y) * w + (bx + x)) * 4;
          const col = on ? 0 : 255;
          data[idx] = data[idx + 1] = data[idx + 2] = col;
          data[idx + 3] = 255;
          bit++;
        }
      }
    }
  }

  ctx.putImageData(imageData, 0, 0);

  // Now upscale properly to main canvas
  const mainCtx = canvas.getContext('2d');
  canvas.width = w * scale;
  canvas.height = h * scale;
  mainCtx.imageSmoothingEnabled = false;
  mainCtx.clearRect(0, 0, canvas.width, canvas.height);
  mainCtx.drawImage(off, 0, 0, w * scale, h * scale);
}

document.getElementById('upload').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = () => {
    const code = encodeImage(img);
    document.getElementById('output').value = code;
  };
  img.src = URL.createObjectURL(file);
});

document.getElementById('decodeBtn').addEventListener('click', () => {
  const code = document.getElementById('inputString').value.trim();
  const canvas = document.getElementById('canvas');
  decodeStringToCanvas(code, canvas);
});
</script>

</script>

</body>
</html>
